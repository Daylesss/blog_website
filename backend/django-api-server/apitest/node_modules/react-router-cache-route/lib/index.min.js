!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react"),require("mini-create-react-context"),require("prop-types"),require("react-router-dom")):"function"==typeof define&&define.amd?define(["exports","react","mini-create-react-context","prop-types","react-router-dom"],t):t(e.CacheRoute={},e.React,e.createContext,e.PropTypes,e.reactRouterDom)}(this,function(e,C,t,r,i){"use strict";function o(e){return void 0===e}function N(e){return null===e}function O(e){return"number"==typeof e&&!D(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var j="default"in C?C.default:C,a=(t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,function(e){return"function"==typeof e}),x=function(e){return"string"==typeof e},n=function(e){return!(o(e)||N(e))},q=function(e){return e instanceof Array},D=function(e){return e!=e},l=function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2];try{O(t)&&(t=String(t));var n=(x(t)?t.split("."):t).reduce(function(e,t){return e[t]},e);return o(n)?r:n}catch(e){return r}},E=function(e){for(var t=arguments.length,r=Array(2<t?t-2:0),n=2;n<t;n++)r[n-2]=arguments[n];var o=x(o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[])?o.split("."):o,c=l(e,o),e=l(e,o.slice(0,-1));return a(c)?c.call.apply(c,[e].concat(r)):c},K=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.reduce(function(e,t){return o(e)?E(t):E(e)},void 0)},U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=function(e,t,r){return t&&B(e.prototype,t),r&&B(e,r),e};function B(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function h(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function f(e,t){if(e)return!t||"object"!=typeof t&&"function"!=typeof t?e:t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}function H(e){return e.reduce(function(e,t){return[].concat(p(e),p(q(t)?H(t):[t]))},[])}function W(e){var t,r=[];for(t in e)r.push(e[t]);return r}var P=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r,n=arguments[t];for(r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},R=function(e,t){var r,n={};for(r in e)0<=t.indexOf(r)||Object.prototype.hasOwnProperty.call(e,r)&&(n[r]=e[r]);return n},S=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){var r=t,n=[],o=!0,t=!1,c=void 0;try{for(var a,i=e[Symbol.iterator]();!(o=(a=i.next()).done)&&(n.push(a.value),!r||n.length!==r);o=!0);}catch(e){t=!0,c=e}finally{try{!o&&i.return&&i.return()}finally{if(t)throw c}}return n}throw new TypeError("Invalid attempt to destructure non-iterable instance")},p=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},V=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}(),d="object"===("undefined"==typeof global?"undefined":U(global))&&global&&global.Math===Math&&global.Array===Array?global:V,I=l(d,"document.body"),X=l(d,"document.scrollingElement",l(d,"document.documentElement",{}));function G(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return!!n(e)&&(e.scrollWidth>e.clientWidth||e.scrollHeight>e.clientHeight)}function J(e){return a(l(d,"document.getElementById"))?[].concat(p(K(E(e,"querySelectorAll","*"),[])),[e]).filter(G):[]}function m(){return Object.entries(v).filter(function(e){e=S(e,2)[1];return e instanceof z?e.state.cached:Object.values(e).some(function(e){return e.state.cached})})}function Q(){return P({},v)}function y(e,t){v[e]=t}function Y(e){delete v[e]}function Z(e){return E(e,"reset")}function $(e){(e=l(v,[e]))&&(e instanceof z?Z(e):Object.values(e).forEach(Z))}function ee(e){return E(e,"refresh")}var v={},_=t(),te=_.Provider;_.Consumer;function re(t,e){var r,n;a(C.useContext)&&((r=C.useRef(function(){return null})).current=e,n=C.useContext(_),C.useEffect(function(){var e=E(n,"on",t,function(){E(r.current)});return function(){return E(e)}},[]))}function b(e,t){var r=e.match,n=void 0===(n=e.when)?"forward":n;if(T(r)||(r=null),!t.cached&&r)return{cached:!0,matched:!0};if(t.matched&&!r){var o=l(e,"history.action"),c=!1;if(a(n))c=!n(e);else switch(n){case"always":break;case"back":["PUSH","REPLACE"].includes(o)&&(c=!0);break;default:"POP"===o&&(c=!0)}if(c)return{cached:!1,matched:!1}}return{matched:!!r}}var U=re.bind(null,"didCache"),V=re.bind(null,"didRecover"),ne=n(j.forwardRef),oe="__isComputedUnmatch",T=function(e){return n(e)&&!0!==l(e,oe)},z=(t=C.Component,h(w,t),c(w,[{key:"componentDidUpdate",value:function(e,t){if(t.cached&&this.state.cached)return!0===t.matched&&!1===this.state.matched?(this.props.unmount&&this.ejectDOM(),this.__cacheUpdateTime=Date.now(),W(this.cacheLifecycles.__didCacheListener).forEach(function(e){E(e)}),E(this,"cacheLifecycles.__listener.didCache")):!1===t.matched&&!0===this.state.matched?(this.props.saveScrollPosition&&E(this.__revertScrollPos),this.__cacheUpdateTime=Date.now(),W(this.cacheLifecycles.__didRecoverListener).forEach(function(e){E(e)}),E(this,"cacheLifecycles.__listener.didRecover")):void 0}},{key:"shouldComponentUpdate",value:function(e,t){var r,n=!1===this.state.matched&&!0===t.matched,o=!0===this.state.cached&&!1===t.cached,t=this.state.matched||t.matched||this.state.cached!==t.cached;return t&&((this.props.unmount&&o||n)&&this.injectDOM(),o||n||!this.props.saveScrollPosition||(this.__revertScrollPos=(o=this.props.unmount?this.wrapper:void 0,r=[].concat(p(new Set([].concat(p(H((q(o)?o:[o]).map(J))),p([X,I].filter(G)))))).map(function(e){return[e,{x:e.scrollLeft,y:e.scrollTop}]}),function(){r.forEach(function(e){var e=S(e,2),t=e[0],e=e[1],r=e.x,e=e.y;t.scrollLeft=r,t.scrollTop=e})}))),t}},{key:"componentWillUnmount",value:function(){var e=this.props,t=e.unmount,r=e.href,e=e.multiple,n=E(this.props,"cacheKey",this.props);!e||(delete(e=P({},Q()[n]))[r],0===Object.keys(e).length)?Y(n):y(n,e),t&&this.injectDOM()}},{key:"render",value:function(){var t=this,e=this.state,r=e.matched,n=e.cached,e=e.key,o=this.props,c=o.className,c=void 0===c?"":c,a=o.behavior,o=o.children,a=K(E(a,void 0,!r),{}),r=a.className,r=void 0===r?"":r,a=R(a,["className"]),c=E(c+" "+r,"trim");return n?j.createElement("div",P({key:e,className:""!==c?c:void 0},a,{ref:function(e){t.wrapper=e}}),j.createElement(te,{value:this.cacheLifecycles},E(o,void 0,this.cacheLifecycles))):null}}]),w);function w(e){u(this,w);for(var t=arguments.length,r=Array(1<t?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];var o,c,a=f(this,(o=w.__proto__||Object.getPrototypeOf(w)).call.apply(o,[this,e].concat(r)));return a.cacheLifecycles={__listener:{},__didCacheListener:{},__didRecoverListener:{},on:function(e,t){var r=Math.random(),n="__"+e+"Listener";return a.cacheLifecycles[n][r]=t,function(){delete a.cacheLifecycles[n][r]}},didCache:function(e){a.cacheLifecycles.__listener.didCache=e},didRecover:function(e){a.cacheLifecycles.__listener.didRecover=e}},a.componentWillReceiveProps=ne?void 0:function(e){e=b(e,a.state);a.setState(e)},a.injectDOM=function(){try{E(a.__parentNode,"insertBefore",a.wrapper,a.__placeholderNode),E(a.__parentNode,"removeChild",a.__placeholderNode)}catch(e){}},a.ejectDOM=function(){try{var e=l(a.wrapper,"parentNode");a.__parentNode=e,E(a.__parentNode,"insertBefore",a.__placeholderNode,a.wrapper),E(a.__parentNode,"removeChild",a.wrapper)}catch(e){}},a.reset=function(){delete a.__revertScrollPos,a.setState({cached:!1})},a.refresh=function(){delete a.__revertScrollPos,a.setState({key:Math.random()})},a.__cacheCreateTime=Date.now(),a.__cacheUpdateTime=a.__cacheCreateTime,e.cacheKey&&(o=E(e.cacheKey,void 0,e),e.multiple?(c=e.href,y(o,P({},Q()[o],s({},c,a)))):y(o,a)),"undefined"!=typeof document&&(c=E(e.cacheKey,void 0,e),a.__placeholderNode=document.createComment(" Route cached "+(c?'with cacheKey: "'+c+'" ':""))),a.state=b(e,{cached:!1,matched:!1,key:Math.random()}),a}z.__name="CacheComponent",z.propsTypes={history:r.object.isRequired,match:r.object.isRequired,children:r.func.isRequired,className:r.string,when:r.oneOfType([r.func,r.oneOf(["forward","back","always"])]),behavior:r.func,unmount:r.bool,saveScrollPosition:r.bool},z.defaultProps={when:"forward",unmount:!1,saveScrollPosition:!1,behavior:function(e){return e?{style:{display:"none"}}:void 0}},z.getDerivedStateFromProps=ne?b:void 0;var ce=!(a(C.lazy)&&!o(C.Suspense)),ae=(t=C.Component,h(g,t),c(g,[{key:"render",value:function(){var e=this.props,t=e.freeze,e=e.children,r=this.promiseCache;if(t&&!r.promise)throw r.promise=new Promise(function(e){r.resolve=e}),r.promise;if(t)throw r.promise;return r.promise&&(r.resolve(),r.promise=void 0),j.createElement(C.Fragment,null,e)}}]),g);function g(){var e;u(this,g);for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return(e=f(this,(e=g.__proto__||Object.getPrototypeOf(g)).call.apply(e,[this].concat(r)))).promiseCache={},f(e,e)}var ie=!!C.Suspense?function(e){var t=e.freeze,r=e.children,e=e.placeholder;return ce?r:j.createElement(C.Suspense,{fallback:void 0===e?null:e},j.createElement(ae,{freeze:t},r))}:function(e){return e.children},ue=(t=C.Component,h(L,t),L);function L(e){u(this,L);var r=f(this,(L.__proto__||Object.getPrototypeOf(L)).call(this,e));return r.state={freeze:!1},r.freezeTimeout=null,r.shouldComponentUpdate=function(e){var t=e.freeze,e=r.props.freeze;return t!==e&&(clearTimeout(r.freezeTimeout),r.freezeTimeout=setTimeout(function(){r.setState({freeze:t})},1e3)),!0},r.render=function(){return j.createElement(ie,{freeze:!!r.props.freeze&&r.state.freeze},E(r.props,"children"))},r.state={freeze:e.freeze},r}ue.propsTypes={freeze:r.bool.isRequired};t=C.Component,h(k,t);var le=k;function k(){var e,t;u(this,k);for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];return(e=t=f(this,(e=k.__proto__||Object.getPrototypeOf(k)).call.apply(e,[this].concat(n)))).render=function(){return E(t.props,"children")},t.shouldComponentUpdate=function(e){return e.when},f(t,e)}le.propsTypes={when:r.bool.isRequired};function se(e){var t=void 0===(t=e.autoFreeze)||t,e=R(e,["autoFreeze"]);return j.createElement(ue,{freeze:t&&!e.when},j.createElement(le,e))}var he=n(C.Fragment),t=(t=C.Component,h(A,t),c(A,[{key:"render",value:function(){var e,s=this,t=this.props,h=t.children,f=t.render,p=t.component,d=t.className,m=t.when,y=t.behavior,v=t.cacheKey,_=t.unmount,b=t.saveScrollPosition,r=t.computedMatchForCacheRoute,w=t.multiple,g=t.autoFreeze,t=R(t,["children","render","component","className","when","behavior","cacheKey","unmount","saveScrollPosition","computedMatchForCacheRoute","multiple","autoFreeze"]);return!j.isValidElement(h)&&(e=h,0===j.Children.count(e))||(f=function(){return h}),r&&(t.computedMatch=r),O(w=w&&!he?!1:w)&&(w=function(e,t){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Number.MAX_VALUE;return e<t?t:r<e?r:e}(w,1)),j.createElement(i.Route,t,function(o){function e(t){return j.createElement(z,t,function(e){return j.createElement(se,{when:T(t.match),autoFreeze:g},function(){return Object.assign(t,{cacheLifecycles:e}),p?j.createElement(p,t):E(f||h,void 0,t)})})}var c=o.match,a=o.computedMatch,t=o.location,r=T(o.match),i=t.pathname,u=t.search,n=O(w)?w:1/0,l={when:m,className:d,behavior:y,cacheKey:v,unmount:_,saveScrollPosition:b};return w&&r&&(s.cache[t=i+u]={updateTime:Date.now(),href:t,pathname:i,render:e},Object.entries(s.cache).sort(function(e,t){e=S(e,2)[1];return S(t,2)[1].updateTime-e.updateTime}).forEach(function(e,t){e=S(e,1)[0];n<=t&&delete s.cache[e]})),w?j.createElement(C.Fragment,null,Object.entries(s.cache).map(function(e){var e=S(e,2),t=e[0],e=e[1],r=e.render,n=e.href,e=e.pathname;return j.createElement(C.Fragment,{key:t},r(P({},o,l,{cacheKey:v,pathname:e,href:n,multiple:!0,key:t,match:t===i+u?c||a:null})))})):e(P({},o,l,{pathname:i,href:i,multiple:!1}))})}}]),A);function A(){var e;u(this,A);for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return(e=f(this,(e=A.__proto__||Object.getPrototypeOf(A)).call.apply(e,[this].concat(r)))).cache={},f(e,e)}t.__name="CacheRoute",t.propTypes={component:r.elementType||r.any,render:r.func,children:r.oneOfType([r.func,r.node]),computedMatchForCacheRoute:r.object,multiple:r.oneOfType([r.bool,r.number]),autoFreeze:r.bool},t.defaultProps={multiple:!1};var fe=n(C.Fragment)?function(e){e=e.children;return j.createElement(C.Fragment,null,e)}:n(C.PropTypes)?function(e){e=e.children;return j.createElement("div",null,e)}:function(e){return e.children},pe=(fe.displayName="SwitchFragment",n(i.__RouterContext)||n(i.useHistory)),F=(F=i.Switch,h(M,F),c(M,[{key:"render",value:function(){var e=this.props,t=e.children,n=e.which,e=e.autoFreeze,r=this.getContext(),o=r.location,c=r.match,a=!1;return j.createElement(se,{when:T(c),autoFreeze:e},function(){return j.createElement(fe,null,j.Children.map(t,function(e){var t,r;return j.isValidElement(e)?(t=e.props.path||e.props.from,t=a?null:t?i.matchPath(o.pathname,P({},e.props,{path:t}),c):c,r=void 0,r=n(e)?j.cloneElement(e,P({location:o,computedMatch:t},N(t)?{computedMatchForCacheRoute:s({},oe,!0)}:null)):t&&!a?j.cloneElement(e,{location:o,computedMatch:t}):null,a=a||!!t,r):null}))})}}]),M);function M(){var e,t;u(this,M);for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];return(t=f(this,(e=M.__proto__||Object.getPrototypeOf(M)).call.apply(e,[this].concat(n)))).getContext=function(){var e;return pe?{location:(e=t.props).location,match:e.match}:(e=t.context.router.route,{location:t.props.location||e.location,match:e.match})},f(t,t)}pe?(F.propTypes={children:r.node,location:r.object.isRequired,match:r.object.isRequired,which:r.func},F=i.withRouter(F)):(F.contextTypes={router:r.shape({route:r.object.isRequired}).isRequired},F.propTypes={children:r.node,location:r.object,which:r.func}),F.defaultProps={which:function(e){return"CacheRoute"===l(e,"type.__name")}};c=F;e.default=t,e.CacheRoute=t,e.CacheSwitch=c,e.dropByCacheKey=$,e.refreshByCacheKey=function(e){e=l(v,[e]);e&&(e instanceof z?ee(e):Object.values(e).forEach(ee))},e.getCachingKeys=function(){return m().map(function(e){return S(e,1)[0]})},e.clearCache=function(){m().forEach(function(e){e=S(e,1)[0];return $(e)})},e.getCachingComponents=function(){return m().reduce(function(e,t){var t=S(t,2),n=t[0],t=t[1];return P({},e,t instanceof z?s({},n,t):Object.entries(t).reduce(function(e,t){var t=S(t,2),r=t[0],t=t[1];return P({},e,s({},n+"."+r,t))},{}))},{})},e.useDidCache=U,e.useDidRecover=V,Object.defineProperty(e,"__esModule",{value:!0})});
